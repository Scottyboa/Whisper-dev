<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title-transcribe">Transcription Tool with Ads and Guide Overlay</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&family=Merriweather:wght@300;400&display=swap" rel="stylesheet">
  <!-- CSS -->
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f8f8;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 10px;
      resize: vertical;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
      border-radius: 8px;
    }
    .status {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>Whisper Transcription Tool</h2>

  <div id="recordIndicator" style="width:20px;height:20px;border-radius:50%;background-color:grey;"></div>
  <textarea id="transcription" placeholder="Transcription appears here..."></textarea>

  <div>
    <button id="startButton">Start Recording</button>
    <button id="stopButton" disabled>Stop Recording</button>
    <button id="pauseResumeButton" disabled>Pause Recording</button>
    <button id="transcribeButton" disabled>Transcribe</button>
  </div>

  <p id="statusMessage">Click "Start Recording" to begin.</p>

  <script>
    let mediaStream, activeRecorder, groupId, chunkNumber = 1, manualStop = false;

    const updateStatus = msg => document.getElementById('statusMessage').textContent = msg;

    async function uploadChunk(blob, currentChunkNumber) {
      const formData = new FormData();
      formData.append("file", blob, `chunk_${currentChunkNumber}.mp3`);
      formData.append("group_id", groupId);
      formData.append("chunk_number", currentChunkNumber);

      try {
        const response = await fetch('/upload', { method: 'POST', body: formData });
        const result = await response.json();
        if (result.session_id) {
          document.getElementById("statusMessage").textContent = `Chunk ${currentChunkNumber} uploaded.`;
        } else {
          document.getElementById("statusMessage").textContent = `Upload failed for chunk ${currentChunkNumber}: ${result.error}`;
        }
      } catch (error) {
        document.getElementById("statusMessage").textContent = `Error uploading chunk ${currentChunkNumber}: ${error}`;
      }
    }

    document.getElementById("startButton").onclick = async () => {
      manualStop = false;
      groupId = Date.now().toString();
      chunkNumber = 1;
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      activeRecorder = new MediaRecorder(mediaStream);
      activeRecorder.start();

      activeRecorder.ondataavailable = async event => {
        if (event.data.size > 0) {
          await uploadChunk(event.data, chunkNumber++);
        }
        if (!manualStop) {
          activeRecorder.start();
        } else {
          document.getElementById("transcribeButton").disabled = false;
          updateStatusMessage("Recording stopped. You can now transcribe.");
        }
      };

      setTimeout(() => activeRecorder.stop(), 120000);
      document.getElementById("stopButton").disabled = false;
      document.getElementById("startButton").disabled = true;
      document.getElementById("statusMessage").textContent = "Recording...";
    };

    document.getElementById("stopButton").onclick = () => {
      manualStop = true;
      activeRecorder.stop();
      mediaStream.getTracks().forEach(track => track.stop());
      document.getElementById("statusMessage").textContent = "Recording stopped.";
      document.getElementById("transcribeButton").disabled = false;
    };

    document.getElementById("transcribeButton").onclick = async () => {
      const response = await fetch('/transcribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: groupId, api_key: sessionStorage.getItem("openai_api_key") })
      });
      const result = await response.json();

      if (result.transcription) {
        document.getElementById("transcription").value = result.transcription;
        document.getElementById("statusMessage").textContent = "Transcription successful!";
      } else {
        document.getElementById("statusMessage").textContent = "Transcription failed: " + (result.error || 'unknown error');
      }
    };
  </script>
</body>
</html>
