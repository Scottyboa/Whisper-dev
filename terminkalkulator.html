<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Terminkalkulator</title>

  <!-- Match fonts used in transcribe.html -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&family=Merriweather:wght@300;400&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    /* Base Styles (mirrors transcribe.html) */
    html, body { margin: 0; padding: 0; }
    body {
      font-family: 'Inter', 'Roboto', sans-serif;
      font-weight: 400;
      background-color: #f8f8f8;
      color: #333;
    }
    input, select, textarea, button { font-family: inherit; font-weight: 400; }
    label { font-family: inherit; font-weight: 400; }

    /* Use the same general layout approach (single column, "ads disabled") */
    .grid-container {
      display: grid;
      grid-template-columns: 1fr;
      grid-template-rows: auto;
      min-height: 100vh;
    }
    .main-content {
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 0;
    }

    /* Top Bar (same look/feel) */
    .top-bar {
      background-color: #e0e0e0;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .top-bar .title {
      font-size: 22px;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    /* Button styles (copied style spirit from transcribe.html) */
    button {
      background-color: #5a9;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
      margin: 0;
    }
    button:hover { background-color: #489; }
    button:active { transform: scale(0.98); }
    button:disabled {
      background-color: #ccc;
      color: #666;
      cursor: not-allowed;
      opacity: 0.6;
      transition: none;
      transform: none;
    }

    /* Content spacing similar to recording-area padding */
    .content {
      padding: 0 20px 30px;
    }

    /* Calculator block */
    .calc-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 18px;
      box-sizing: border-box;
    }

    .section-title {
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .muted {
      margin: 0 0 14px;
      color: #666;
      font-size: 14px;
      line-height: 1.4;
    }

    .row {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      align-items: flex-end;
      margin-bottom: 14px;
    }

    .field {
      flex: 1 1 260px;
      min-width: 220px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-size: 14px;
      color: #333;
    }

    .field input[type="date"],
    .field input[type="number"],
    .field select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      box-sizing: border-box;
      background: #fff;
      color: #333;
    }

    .mode-group {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      align-items: center;
      margin: 10px 0 8px;
    }

    .radio {
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    .radio input { transform: scale(1.1); }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 6px;
    }

    .results {
      margin-top: 16px;
      border-top: 1px solid #eee;
      padding-top: 14px;
      display: grid;
      gap: 10px;
    }

    .result-line {
      background: #f7f7f7;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 12px;
      line-height: 1.4;
    }

    .result-label {
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    .error {
      background: #fff1f1;
      border-color: #f2b3b3;
      color: #8a1f1f;
    }

    .hint {
      font-size: 12px;
      color: #666;
      margin: 6px 0 0;
      line-height: 1.35;
    }

    @media (max-width: 520px) {
      .top-bar { padding: 16px; }
      .content { padding: 0 14px 24px; }
    }
  </style>
</head>

<body>
  <div class="grid-container">
    <main class="main-content">
      <div class="top-bar">
        <button id="backBtn" type="button" aria-label="Tilbake">Back to frontpage</button>
        <h1 class="title">Terminkalkulator</h1>
        <span style="min-width: 160px;"></span>
      </div>

      <div class="content">
        <div class="calc-card" aria-labelledby="calcTitle">
          <h2 id="calcTitle" class="section-title">Beregn termin</h2>
          <p class="muted">
            Velg om du vil beregne fra første dag i siste menstruasjon eller fra termindato.
          </p>

          <div class="mode-group" role="radiogroup" aria-label="Velg tidspunkt for beregning">
            <label class="radio">
              <input type="radio" name="calcMode" value="lmp" checked />
              <span>Beregn fra første dag i siste menstruasjon</span>
            </label>
            <label class="radio">
              <input type="radio" name="calcMode" value="due" />
              <span>Beregn fra termindato</span>
            </label>
          </div>

          <div class="row">
            <div class="field">
              <label id="dateLabel" for="dateInput">Første dag i siste menstruasjon</label>
              <input id="dateInput" type="date" />
              <p class="hint" id="dateHint">Velg dato.</p>
            </div>

            <div class="field" id="cycleField">
              <label for="cycleLength">Sykluslengde (dager)</label>
              <input id="cycleLength" type="number" min="20" max="45" step="1" value="28" />
              <p class="hint">Hvis du er usikker, bruk 28 dager.</p>
            </div>
          </div>

          <div class="actions">
            <button id="calcBtn" type="button">Beregn</button>
            <button id="resetBtn" type="button" style="background-color:#777;">Nullstill</button>
          </div>

          <div class="results" aria-live="polite" aria-atomic="true">
            <div id="resultDue" class="result-line">
              <span class="result-label">Din antatte termindato er:</span>
              <span id="outDue">—</span>
            </div>

            <div id="resultWeek" class="result-line">
              <span class="result-label">Svangerskapsuke:</span>
              <span id="outWeek">—</span>
            </div>

            <div id="resultLeft" class="result-line">
              <span class="result-label">Tid igjen til termindato:</span>
              <span id="outLeft">—</span>
            </div>

            <div id="resultConception" class="result-line">
              <span class="result-label">Sannsynlig befruktningsdato:</span>
              <span id="outConception">—</span>
            </div>

            <div id="resultError" class="result-line error" style="display:none;">
              <span class="result-label">Obs:</span>
              <span id="outError"></span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ---------- Date helpers (UTC "date-only" math to avoid DST off-by-one) ----------
    const MS_PER_DAY = 24 * 60 * 60 * 1000;

    function toUtcDateOnly(dateLike) {
      // Accepts Date or {y,m,d} or "YYYY-MM-DD"
      if (dateLike instanceof Date) {
        return Date.UTC(dateLike.getFullYear(), dateLike.getMonth(), dateLike.getDate());
      }
      if (typeof dateLike === "string") {
        // "YYYY-MM-DD"
        const [y, m, d] = dateLike.split("-").map(Number);
        if (!y || !m || !d) return null;
        return Date.UTC(y, m - 1, d);
      }
      if (dateLike && typeof dateLike === "object") {
        const { y, m, d } = dateLike;
        return Date.UTC(y, m - 1, d);
      }
      return null;
    }

    function addDays(utcMs, days) {
      return utcMs + (days * MS_PER_DAY);
    }

    function diffDays(utcMsA, utcMsB) {
      // A - B in whole days
      return Math.round((utcMsA - utcMsB) / MS_PER_DAY);
    }

    function formatNo(utcMs) {
      const dt = new Date(utcMs);
      const dd = String(dt.getUTCDate()).padStart(2, "0");
      const mm = String(dt.getUTCMonth() + 1).padStart(2, "0");
      const yyyy = dt.getUTCFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    function weeksAndDaysLabel(totalDays) {
      const w = Math.floor(totalDays / 7);
      const d = totalDays % 7;
      return { w, d, label: `${w}+${d}` };
    }

    function timeLeftLabel(daysLeft) {
      const abs = Math.abs(daysLeft);
      const w = Math.floor(abs / 7);
      const d = abs % 7;

      if (daysLeft > 0) return `${w} uker og ${d} dager`;
      if (daysLeft === 0) return `I dag`;
      return `Termindato var for ${w} uker og ${d} dager siden`;
    }

    // ---------- Calculator logic ----------
    // Norsk standard i mange terminkalkulatorer:
    //  - Termin: 283 dager (40+3) fra første dag i siste menstruasjon
    //  - Syklusjustering: + (sykluslengde - 28)
    //
    // Sannsynlig befruktning (slik mange kalkulatorer viser den):
    //  - fra LMP: LMP + (sykluslengde - 14)
    //  - fra termindato: antar 28-dagers syklus => LMP = termindato - 283, befruktning = LMP + 14 => termindato - 269
    const TERM_FROM_LMP_DAYS = 283;     // 40+3
    const DEFAULT_CYCLE_LEN = 28;
    const OVULATION_OFFSET = 14;        // ~14 dager før neste mens

    function computeFromLmp(lmpUtc, cycleLen) {
      const cl = Number.isFinite(cycleLen) ? cycleLen : DEFAULT_CYCLE_LEN;
      const adj = cl - DEFAULT_CYCLE_LEN;

      const dueUtc = addDays(lmpUtc, TERM_FROM_LMP_DAYS + adj);

      // Befruktning slik kalkulatorer ofte estimerer:
      const conceptionUtc = addDays(lmpUtc, cl - OVULATION_OFFSET);

      return { dueUtc, conceptionUtc };
    }

    function computeFromDue(dueUtc) {
      // Antar 28-dagers syklus når sykluslengde ikke er oppgitt:
      const conceptionUtc = addDays(dueUtc, -(TERM_FROM_LMP_DAYS - OVULATION_OFFSET)); // 283-14 = 269
      return { dueUtc, conceptionUtc };
    }

    function gestationalFromDue(todayUtc, dueUtc) {
      // GA days = 283 - daysLeft (40+3 ved termin)
      const daysLeft = diffDays(dueUtc, todayUtc);
      const gaDays = TERM_FROM_LMP_DAYS - daysLeft;
      return { daysLeft, gaDays };
    }

    function safeInt(v, min, max, fallback) {
      const n = Number.parseInt(v, 10);
      if (!Number.isFinite(n)) return fallback;
      if (typeof min === "number" && n < min) return fallback;
      if (typeof max === "number" && n > max) return fallback;
      return n;
    }

    // ---------- UI wiring ----------
    const backBtn = document.getElementById("backBtn");
    const calcBtn = document.getElementById("calcBtn");
    const resetBtn = document.getElementById("resetBtn");
    const dateInput = document.getElementById("dateInput");
    const dateLabel = document.getElementById("dateLabel");
    const dateHint = document.getElementById("dateHint");
    const cycleField = document.getElementById("cycleField");
    const cycleLength = document.getElementById("cycleLength");

    const outDue = document.getElementById("outDue");
    const outWeek = document.getElementById("outWeek");
    const outLeft = document.getElementById("outLeft");
    const outConception = document.getElementById("outConception");

    const errBox = document.getElementById("resultError");
    const outError = document.getElementById("outError");

    function setError(msg) {
      if (!msg) {
        errBox.style.display = "none";
        outError.textContent = "";
        return;
      }
      errBox.style.display = "block";
      outError.textContent = msg;
    }

    function getMode() {
      const el = document.querySelector('input[name="calcMode"]:checked');
      return el ? el.value : "lmp";
    }

    function updateModeUi() {
      const mode = getMode();
      if (mode === "lmp") {
        dateLabel.textContent = "Første dag i siste menstruasjon";
        dateHint.textContent = "Velg dato for første dag i siste menstruasjon.";
        cycleField.style.display = "";
      } else {
        dateLabel.textContent = "Termindato";
        dateHint.textContent = "Velg termindato (f.eks. fra ultralyd).";
        cycleField.style.display = "none";
      }
      setError("");
    }

    function clearOutputs() {
      outDue.textContent = "—";
      outWeek.textContent = "—";
      outLeft.textContent = "—";
      outConception.textContent = "—";
      setError("");
    }

    function calculate() {
      setError("");
      const mode = getMode();
      const todayUtc = toUtcDateOnly(new Date());
      const chosenUtc = toUtcDateOnly(dateInput.value);

      if (!chosenUtc) {
        clearOutputs();
        setError("Velg en gyldig dato først.");
        return;
      }

      let dueUtc, conceptionUtc;

      if (mode === "lmp") {
        const cl = safeInt(cycleLength.value, 20, 45, DEFAULT_CYCLE_LEN);
        ({ dueUtc, conceptionUtc } = computeFromLmp(chosenUtc, cl));
      } else {
        ({ dueUtc, conceptionUtc } = computeFromDue(chosenUtc));
      }

      const { daysLeft, gaDays } = gestationalFromDue(todayUtc, dueUtc);

      // Guardrails (still compute, but warn)
      if (gaDays < -14) {
        setError("Datoen ser ut til å ligge langt frem i tid. Sjekk at du har valgt riktig dato.");
      } else if (gaDays > 333) {
        setError("Datoen ser ut til å ligge langt tilbake i tid. Sjekk at du har valgt riktig dato.");
      }

      const gad = Math.max(0, gaDays);
      const { label: weekLabel } = weeksAndDaysLabel(gad);

      outDue.textContent = formatNo(dueUtc);
      outWeek.textContent = `Uke ${weekLabel}`;
      outLeft.textContent = timeLeftLabel(daysLeft);
      outConception.textContent = formatNo(conceptionUtc);
    }

    // Back button: mimic transcribe.html behavior (best-effort)
    backBtn.addEventListener("click", () => {
      const loc = window.location;
      const newPath = loc.pathname.replace(/\/[^\/]*$/, "/index.html");
      window.location.href = loc.origin + newPath + loc.search + loc.hash;
    });

    // Events
    document.querySelectorAll('input[name="calcMode"]').forEach(r => {
      r.addEventListener("change", () => {
        updateModeUi();
        if (dateInput.value) calculate();
      });
    });

    calcBtn.addEventListener("click", calculate);

    resetBtn.addEventListener("click", () => {
      dateInput.value = "";
      cycleLength.value = String(DEFAULT_CYCLE_LEN);
      document.querySelector('input[name="calcMode"][value="lmp"]').checked = true;
      updateModeUi();
      clearOutputs();
    });

    dateInput.addEventListener("change", calculate);
    cycleLength.addEventListener("change", () => {
      if (getMode() === "lmp" && dateInput.value) calculate();
    });

    // Init
    updateModeUi();
    clearOutputs();
  </script>
</body>
</html>
